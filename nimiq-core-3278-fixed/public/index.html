<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nimiq-core-3278 Fixed</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1 { color: #51cf66; }
        button {
            background: #51cf66;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            margin: 20px 0;
        }
        button:hover { background: #45b359; }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        #console {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 20px;
            min-height: 400px;
            overflow-y: auto;
            border-radius: 5px;
        }
        .log { padding: 5px 0; border-bottom: 1px solid #222; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #4ecdc4; }
        .warn { color: #ffa94d; }
    </style>
</head>
<body>
    <h1>✅ nimiq-core-3278: Fixed with Patch</h1>
    <p>This page uses pnpm patch to fix the import issue.</p>
    <p>Fixed: <code>import * as Comlink from 'comlink'</code> in nodejs/*.mjs files.</p>

    <button id="connectBtn" onclick="connectToNimiq()">Connect to Nimiq</button>

    <h2>Console:</h2>
    <div id="console"></div>

    <script type="module">
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `log ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        window.connectToNimiq = async function() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;

            log('Starting connection to Nimiq network...', 'info');
            log('Importing @nimiq/core module (patched version)...', 'info');

            try {
                // Try to import @nimiq/core
                const { Client } = await import('@nimiq/core');
                log('✓ Module imported successfully', 'success');

                log('Creating Nimiq client...', 'info');
                const client = await Client.create({ network: 'test' });
                log('✓ Client created successfully!', 'success');

                log('Connected to Nimiq network', 'success');
                log('Client ready', 'success');
                log('', 'info');
                log('✓ The patch works! Imports use correct namespace syntax.', 'success');

            } catch (error) {
                log('✗ ERROR: ' + error.message, 'error');
                log('Stack trace:', 'error');
                error.stack.split('\n').forEach(line => {
                    if (line.trim()) log('  ' + line.trim(), 'error');
                });

                if (error.message.includes('comlink') || error.message.includes('default')) {
                    log('', 'warn');
                    log('⚠ Unexpected: Comlink import error still present!', 'warn');
                    log('Check that patches/ directory exists and is applied', 'warn');
                }
            }

            btn.disabled = false;
        }

        log('Page loaded. Click "Connect to Nimiq" to test patched version.', 'info');
        log('Expected: Successful connection (patch applied)', 'success');
    </script>
</body>
</html>
