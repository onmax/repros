# Formula 100 Auth Migration Test

Minimal reproduction for PR #29: nuxt-better-auth + NuxtHub v0.10 migration

## PR Details

- **Repo**: onmax/formula-100
- **PR**: #29 - feat: migrate to nuxt-better-auth + NuxtHub v0.10
- **URL**: https://github.com/onmax/formula-100/pull/29

## Changes Tested

1. **Auth Module**: Manual better-auth ‚Üí `@onmax/nuxt-better-auth` module
2. **NuxtHub**: v0.9 ‚Üí v0.10.4 with `hub:db` virtual imports
3. **Database**: Moved `server/database/` ‚Üí `server/db/` (v0.10 convention)
4. **Auth Tables**: Auto-generated via module (user, session, account, verification)
5. **Route Protection**: Via `routeRules` instead of middleware

## Setup

```bash
pnpm install
pnpm dev
```

## Test Flow

### Manual Testing

1. Visit http://localhost:3007
2. Sign up at /signup
3. Login at /login
4. Access protected /app route
5. Try /admin route (should be blocked for non-admin)
6. Logout

### Programmatic Testing

Start dev server, then:

```bash
npx tsx test-auth.ts
```

## Key Files

- `server/auth.config.ts` - Better Auth server config with admin plugin
- `app/auth.config.ts` - Client auth config
- `app/composables/useAuth.ts` - Auth composable (uses module's useUserSession)
- `nuxt.config.ts` - NuxtHub + auth module config with routeRules
- `server/db/schema/` - Database schema (auth tables auto-generated)

## Configuration

### NuxtHub v0.10

```ts
hub: {
  db: 'sqlite',
  kv: true,
}
```

### Route Protection

```ts
routeRules: {
  '/app/**': { auth: 'user' },
  '/admin/**': { auth: { user: { role: 'admin' } } },
  '/login': { auth: 'guest' },
  '/signup': { auth: 'guest' },
}
```

### Auth Module

```ts
modules: ['@nuxthub/core', '@onmax/nuxt-better-auth']

auth: {
  redirects: {
    login: '/login',
    guest: '/',
  },
}
```

## Database Integration

Auth tables auto-generated by `@onmax/nuxt-better-auth`:
- user
- session
- account
- verification

Custom tables defined in `server/db/schema/`:
- test_data (example)

## Session Management

The module provides `useUserSession()` composable:
- `session` - Current session
- `user` - Current user
- `loggedIn` - Boolean
- `client` - Better Auth client
- `fetchSession()` - Refresh session
- `signIn()`, `signUp()`, `signOut()`

## Issues Found

### ‚úÖ Working

1. **Typecheck passes** - All types resolve correctly
2. **Dev server starts** - No runtime errors on boot
3. **Database schema generation** - Auth tables auto-created
4. **Module integration** - NuxtHub + better-auth work together
5. **Route rules** - Config accepted without errors

### ‚ö†Ô∏è Needs Manual Testing

1. **Login/logout flow** - Need running server to test
2. **Session persistence** - Cookie handling across requests
3. **Route protection** - Middleware enforcement
4. **Role-based access** - Admin vs user vs founder
5. **Database queries** - Auth tables properly populated

### üîç Potential Issues

1. **Admin plugin config** - Required `createAccessControl` and proper role definitions
   - File: `server/auth.config.ts:27`
   - Fix: Import from `better-auth/plugins/access` and use `adminAc`/`userAc` statements

2. **Environment variables** - Module expects `BETTER_AUTH_SECRET` at build time
   - File: `nuxt.config.ts`
   - Fix: Define in `.env` or provide default in config

3. **useAuth composable** - Type mismatches with role field
   - File: `app/composables/useAuth.ts:52`
   - Note: Role can be null, needs proper type narrowing

## Comparison with Original PR

### Matches PR Structure ‚úÖ

- Auth config uses same plugin pattern
- Database schema in `server/db/schema/`
- Route rules for protection
- Composable pattern for client access

### Differences üîÑ

- Simplified: No Stripe webhook handling
- Simplified: No email templates
- Simplified: Fewer database tables
- Same core migration pattern verified

## Next Steps

1. Start dev server: `pnpm dev`
2. Test signup flow manually
3. Test login flow manually
4. Verify session persistence
5. Test protected routes
6. Test admin route blocking
7. Check database tables created

## Build Test

```bash
pnpm typecheck  # ‚úÖ Passes
pnpm build      # Not tested yet
```
