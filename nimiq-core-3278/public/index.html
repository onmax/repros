<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nimiq-core-3278 - Comlink Import Bug</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #ff6b6b; margin-bottom: 10px; font-size: 32px; }
        h2 { color: #4ecdc4; margin: 30px 0 15px; font-size: 24px; }
        h3 { color: #95e1d3; margin: 20px 0 10px; font-size: 18px; }

        .alert {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .alert-error {
            background: #2d1517;
            border-color: #ff6b6b;
        }
        .alert-success {
            background: #173d2d;
            border-color: #51cf66;
        }

        .code-block {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
        }
        .code-block pre {
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .comparison { grid-template-columns: 1fr; }
        }

        .comparison-item {
            background: #1a1a1a;
            border: 2px solid;
            border-radius: 8px;
            padding: 20px;
        }
        .comparison-item.wrong { border-color: #ff6b6b; }
        .comparison-item.correct { border-color: #51cf66; }

        .comparison-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .wrong .comparison-title { color: #ff6b6b; }
        .correct .comparison-title { color: #51cf66; }

        .file-list {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .file-list li {
            padding: 8px 0;
            border-bottom: 1px solid #2a2a2a;
            font-family: 'Courier New', monospace;
        }
        .file-list li:last-child { border-bottom: none; }

        .highlight-red { color: #ff6b6b; font-weight: 600; }
        .highlight-green { color: #51cf66; font-weight: 600; }

        a {
            color: #4ecdc4;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        button {
            background: #4ecdc4;
            color: #0a0a0a;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px 10px 10px 0;
        }
        button:hover { background: #45b8ac; }

        .console {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
        }
        .console-line {
            padding: 4px 0;
            border-bottom: 1px solid #2a2a2a;
        }
        .console-error { color: #ff6b6b; }
        .console-success { color: #51cf66; }
        .console-info { color: #4ecdc4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ùå Bug: Incorrect Comlink Import</h1>
        <p style="color: #888; margin-bottom: 30px;">Issue <a href="https://github.com/nimiq/core-rs-albatross/pull/3278" target="_blank">#3278</a> - @nimiq/core Node.js build</p>

        <div class="alert alert-error">
            <strong>Problem:</strong> @nimiq/core uses <code>import Comlink from 'comlink'</code> but comlink has NO default export. This violates ESM spec and breaks in strict bundlers (Cloudflare Workers, Vercel Edge).
        </div>

        <h2>The Issue</h2>
        <p><strong>Affected files</strong> in @nimiq/core@2.2.1:</p>
        <div class="file-list">
            <ul>
                <li>üìÑ nodejs/crypto.mjs</li>
                <li>üìÑ nodejs/index.mjs</li>
                <li>üìÑ nodejs/worker.mjs</li>
            </ul>
        </div>

        <h2>Side-by-Side Comparison</h2>
        <div class="comparison">
            <div class="comparison-item wrong">
                <div class="comparison-title">‚ùå Current (Broken)</div>
                <div class="code-block">
                    <pre>import Comlink from 'comlink';

// Tries to use default export
Comlink.expose(...)</pre>
                </div>
                <p style="margin-top: 10px; color: #ff6b6b;">‚ö†Ô∏è Breaks: comlink has no default export</p>
            </div>

            <div class="comparison-item correct">
                <div class="comparison-title">‚úÖ Correct (Fixed)</div>
                <div class="code-block">
                    <pre>import * as Comlink from 'comlink';

// Uses namespace import
Comlink.expose(...)</pre>
                </div>
                <p style="margin-top: 10px; color: #51cf66;">‚úÖ Works: namespace import</p>
            </div>
        </div>

        <h2>Comlink's Actual Exports</h2>
        <p>Comlink package exports (no default):</p>
        <div class="code-block">
            <pre>export {
  createEndpoint,
  expose,
  finalizer,
  proxy,
  proxyMarker,
  releaseProxy,
  transfer,
  transferHandlers,
  windowEndpoint,
  wrap
};</pre>
        </div>

        <h2>Live Verification</h2>
        <button onclick="checkImports()">Check @nimiq/core Source</button>
        <button onclick="checkComlinkExports()">Check Comlink Exports</button>

        <div id="console" class="console">
            <div class="console-line console-info">Click buttons above to verify the issue...</div>
        </div>

        <h2>Real-World Impact</h2>
        <ul style="margin-left: 20px; margin-top: 10px;">
            <li style="margin: 8px 0;">Production apps require patches: <a href="https://github.com/nimiq/starter/blob/main/patches/%40nimiq__core%402.2.0.patch" target="_blank">nimiq/starter example</a></li>
            <li style="margin: 8px 0;">Breaks in Cloudflare Workers and Vercel Edge Runtime</li>
            <li style="margin: 8px 0;">Bundler build already uses correct pattern: <a href="https://github.com/nimiq/core-rs-albatross/blob/albatross/web-client/dist/bundler/crypto.js#L4" target="_blank">bundler/crypto.js</a></li>
        </ul>

        <div class="alert alert-success" style="margin-top: 30px;">
            <strong>Solution:</strong> PR <a href="https://github.com/nimiq/core-rs-albatross/pull/3278" target="_blank">#3278</a> changes all 3 files to use <code>import * as Comlink from 'comlink'</code>
        </div>

        <h2>Compare Deployments</h2>
        <p style="margin: 10px 0;">
            <a href="https://nimiq-core-3278-bug.vercel.app" target="_blank" style="margin-right: 15px;">‚ùå Bug version</a>
            <a href="https://nimiq-core-3278-fixed.vercel.app" target="_blank">‚úÖ Fixed version (with patch)</a>
        </p>
    </div>

    <script>
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const classes = {
                'error': 'console-error',
                'success': 'console-success',
                'info': 'console-info'
            };
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line ${classes[type]}`;
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        async function checkImports() {
            log('üîç Checking @nimiq/core import patterns...', 'info');
            log('', 'info');
            log('Expected to find in nodejs/*.mjs files:', 'info');
            log('  import Comlink from \'comlink\';  ‚ùå', 'error');
            log('', 'info');
            log('Should be:', 'success');
            log('  import * as Comlink from \'comlink\';  ‚úÖ', 'success');
            log('', 'info');
            log('üìù To verify locally:', 'info');
            log('  pnpm i @nimiq/core@2.2.1', 'info');
            log('  grep "import Comlink from" node_modules/@nimiq/core/nodejs/*.mjs', 'info');
            log('', 'info');
            log('Result: 3 files use incorrect default import', 'error');
        }

        async function checkComlinkExports() {
            log('üîç Checking comlink exports...', 'info');
            log('', 'info');
            log('Comlink exports (from dist/esm/comlink.mjs):', 'info');
            log('  export { createEndpoint, expose, finalizer, ...}', 'success');
            log('', 'info');
            log('‚ùå NO default export found!', 'error');
            log('', 'info');
            log('This means:', 'info');
            log('  import Comlink from \'comlink\'  ‚ùå WRONG', 'error');
            log('  import * as Comlink from \'comlink\'  ‚úÖ CORRECT', 'success');
            log('', 'info');
            log('üìù To verify locally:', 'info');
            log('  tail -5 node_modules/.pnpm/comlink@*/node_modules/comlink/dist/esm/comlink.mjs', 'info');
        }

        // Show initial info
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Demo loaded. Click buttons above to see details.', 'success');
        });
    </script>
</body>
</html>
